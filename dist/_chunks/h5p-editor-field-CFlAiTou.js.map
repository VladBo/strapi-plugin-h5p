{"version":3,"file":"h5p-editor-field-CFlAiTou.js","sources":["../../admin/src/utils/h5p-content.ts","../../admin/src/components/h5p-editor-field.tsx"],"sourcesContent":["import type { H5PContent } from \"../types\";\n\nexport function parseH5PContent(value: unknown): H5PContent {\n  if (!value) return {};\n  if (typeof value === \"string\") {\n    try {\n      return JSON.parse(value) as H5PContent;\n    } catch (error) {\n      console.error(\"[H5P] Failed to parse H5P content JSON:\", error);\n      return {};\n    }\n  }\n  return value as H5PContent;\n}\n","import { Box, Field, Flex } from \"@strapi/design-system\";\nimport { useField } from \"@strapi/strapi/admin\";\nimport { useCallback, useEffect, useMemo, useRef } from \"react\";\nimport { useIntl } from \"react-intl\";\nimport { H5PEditorUI } from \"@lumieducation/h5p-react\";\nimport type { IEditorModel, IContentMetadata } from \"@lumieducation/h5p-server\";\nimport type { H5PEditorFieldProps, H5PContent } from \"../types\";\nimport { parseH5PContent } from \"../utils/h5p-content\";\n\n/**\n * Hook that intercepts Strapi's Save button to trigger H5P save first.\n */\nfunction useH5PSaveIntercept(\n  editorRef: React.RefObject<H5PEditorUI | null>,\n  hasInteractedRef: React.MutableRefObject<boolean>,\n  isSavingRef: React.MutableRefObject<boolean>,\n) {\n  useEffect(() => {\n    const handleSaveClick = async (event: MouseEvent) => {\n      const target = event.target as HTMLElement;\n      const saveButton = target.closest<HTMLButtonElement>(\"button[data-strapi-save]\") ||\n        target.closest<HTMLButtonElement>(\"button\");\n      if (!saveButton) return;\n\n      // Match by data attribute first, fall back to text content\n      const isSave = saveButton.hasAttribute(\"data-strapi-save\") ||\n        saveButton.textContent?.trim() === \"Save\";\n      if (!isSave) return;\n\n      if (!hasInteractedRef.current || !editorRef.current || isSavingRef.current) return;\n\n      event.preventDefault();\n      event.stopImmediatePropagation();\n      isSavingRef.current = true;\n\n      try {\n        await editorRef.current.save();\n\n        // Let React propagate the field value update\n        await new Promise(resolve => setTimeout(resolve, 150));\n\n        // Re-click Save without interception\n        hasInteractedRef.current = false;\n        isSavingRef.current = false;\n        saveButton.click();\n      } catch {\n        isSavingRef.current = false;\n      }\n    };\n\n    document.addEventListener(\"click\", handleSaveClick, true);\n    return () => document.removeEventListener(\"click\", handleSaveClick, true);\n  }, [editorRef, hasInteractedRef, isSavingRef]);\n}\n\nconst H5PEditorField = (props: H5PEditorFieldProps) => {\n  const {\n    intlLabel,\n    label,\n    name,\n    required,\n    hint,\n    labelAction,\n  } = props;\n  const { formatMessage } = useIntl();\n  const editorRef = useRef<H5PEditorUI>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const isSavingRef = useRef(false);\n\n  const field = useField(name);\n  const { onChange, value } = field;\n\n  const hasInteractedRef = useRef(false);\n  const onChangeRef = useRef(onChange);\n  const fieldValueRef = useRef(value);\n  onChangeRef.current = onChange;\n  fieldValueRef.current = value;\n\n  // Parse the initial content on first render only.\n  const initialContentRef = useRef<H5PContent | null>(null);\n  if (initialContentRef.current === null) {\n    initialContentRef.current = parseH5PContent(value);\n  }\n\n  const contentId = useMemo(() => {\n    const content = initialContentRef.current;\n    if (content?.library && content?.params) {\n      return \"stored\";\n    }\n    return \"new\";\n  }, []);\n\n  const loadContentCallback = useCallback(\n    async (_contentId: string): Promise<IEditorModel & {\n      library?: string;\n      metadata?: IContentMetadata;\n      params?: Record<string, unknown>;\n    }> => {\n      const content = initialContentRef.current || {};\n\n      const response = await fetch(\"/api/h5p/editor-model/new\");\n      if (!response.ok) throw new Error(`Failed to load editor: ${response.status}`);\n      const editorModel = await response.json();\n\n      if (content.library && content.params) {\n        editorModel.library = content.library;\n        const params = content.params as Record<string, unknown>;\n        if (params.params) {\n          editorModel.params = params.params;\n          editorModel.metadata = params.metadata || content.metadata || {};\n        } else {\n          editorModel.params = content.params;\n          editorModel.metadata = content.metadata || {};\n        }\n      }\n\n      return editorModel;\n    },\n    []\n  );\n\n  const saveContentCallback = useCallback(\n    async (\n      _contentId: string,\n      requestBody: { library: string; params: Record<string, unknown> }\n    ): Promise<{ contentId: string; metadata: IContentMetadata }> => {\n      const updatedContent: H5PContent = {\n        library: requestBody.library,\n        params: requestBody.params,\n        metadata: (requestBody.params?.metadata as Record<string, unknown>) || {},\n      };\n\n      const newValue = JSON.stringify(updatedContent);\n\n      // Update initialContentRef so if editor reloads it gets the latest\n      initialContentRef.current = updatedContent;\n\n      onChangeRef.current(name, newValue);\n\n      return {\n        contentId: \"stored\",\n        metadata: (requestBody.params?.metadata || {}) as IContentMetadata,\n      };\n    },\n    [name]\n  );\n\n  /**\n   * Mark form as dirty when user interacts with the H5P editor iframe.\n   */\n  const handleH5PInteraction = useCallback(() => {\n    if (hasInteractedRef.current) return;\n\n    hasInteractedRef.current = true;\n\n    const currentValue = fieldValueRef.current || \"{}\";\n    const valueStr = typeof currentValue === \"string\" ? currentValue : JSON.stringify(currentValue);\n\n    try {\n      const content = JSON.parse(valueStr);\n      content.__dirty = Date.now();\n      onChangeRef.current(name, JSON.stringify(content));\n    } catch {\n      // Value isn't valid JSON; write a minimal dirty marker\n      onChangeRef.current(name, JSON.stringify({ __dirty: Date.now() }));\n    }\n  }, [name]);\n\n  /**\n   * Attach interaction listeners to the H5P iframe.\n   */\n  const attachIframeListeners = useCallback((retries = 0) => {\n    const iframe = containerRef.current?.querySelector(\"iframe\");\n    if (!iframe) {\n      if (retries < 5) {\n        setTimeout(() => attachIframeListeners(retries + 1), 500);\n      }\n      return;\n    }\n\n    try {\n      const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;\n      if (!iframeDoc || !iframeDoc.body) {\n        if (retries < 10) {\n          setTimeout(() => attachIframeListeners(retries + 1), 500);\n        }\n        return;\n      }\n\n      iframeDoc.addEventListener(\"mousedown\", handleH5PInteraction, true);\n      iframeDoc.addEventListener(\"input\", handleH5PInteraction, true);\n      iframeDoc.addEventListener(\"change\", handleH5PInteraction, true);\n    } catch {\n      // Cross-origin fallback\n      iframe.addEventListener(\"mousedown\", handleH5PInteraction);\n      window.addEventListener(\"blur\", () => {\n        if (document.activeElement === iframe) {\n          handleH5PInteraction();\n        }\n      });\n    }\n  }, [handleH5PInteraction]);\n\n  const handleLoaded = useCallback(\n    (_contentId: string, _ubername: string) => {\n      attachIframeListeners();\n    },\n    [attachIframeListeners]\n  );\n\n  const handleSaved = useCallback(\n    (_contentId: string, _metadata: IContentMetadata) => {\n      isSavingRef.current = false;\n    },\n    []\n  );\n\n  const handleSaveError = useCallback(\n    (_errorMessage: string) => {\n      isSavingRef.current = false;\n    },\n    []\n  );\n\n  useH5PSaveIntercept(editorRef, hasInteractedRef, isSavingRef);\n\n  const displayLabel = label || (intlLabel ? formatMessage(intlLabel) : name);\n\n  return (\n    <Field.Root name={name} id={name} error={field.error} hint={hint} required={required}>\n      <Flex\n        direction=\"column\"\n        alignItems=\"stretch\"\n        gap={1}\n        ref={containerRef}\n      >\n        <Field.Label action={labelAction}>{displayLabel}</Field.Label>\n\n        <Box\n          padding={0}\n          background=\"neutral0\"\n          borderColor=\"neutral200\"\n          hasRadius\n          style={{\n            minHeight: \"700px\",\n            overflow: \"hidden\",\n            position: \"relative\",\n            width: \"100%\",\n            maxWidth: \"100%\",\n          }}\n        >\n          <H5PEditorUI\n            ref={editorRef}\n            contentId={contentId}\n            loadContentCallback={loadContentCallback}\n            saveContentCallback={saveContentCallback}\n            onLoaded={handleLoaded}\n            onSaved={handleSaved}\n            onSaveError={handleSaveError}\n          />\n        </Box>\n\n        <Field.Hint />\n        <Field.Error />\n      </Flex>\n    </Field.Root>\n  );\n};\n\nH5PEditorField.displayName = \"H5PEditorField\";\n\nexport default H5PEditorField;\n"],"names":["useEffect","useIntl","useRef","useField","useMemo","useCallback","jsx","Field","jsxs","Flex","Box","H5PEditorUI"],"mappings":"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"}